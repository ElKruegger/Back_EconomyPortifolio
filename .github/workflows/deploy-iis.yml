# Deploy para IIS (máquina local com self-hosted runner)
# Requer: runner instalado na mesma máquina onde está o IIS
# Fluxo em camadas: PR → developer (deploy aqui) → depois main (produção, quando configurar)

name: Build and Deploy to IIS

on:
  push:
    branches: [ developer ]

jobs:
  deploy:
    runs-on: [self-hosted, Windows, X64]   # roda na SUA máquina onde está o IIS.
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish
        run: dotnet publish -c Release -o publish

      - name: Deploy to IIS folder
        run: |
          $dest = "$env:IIS_DEPLOY_PATH"
          if (-not $dest) { $dest = "C:\inetpub\wwwroot\EconomyBackPortifolio" }
          if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest -Force }
          Copy-Item -Path ".\publish\*" -Destination $dest -Recurse -Force

      # Opcional: reiniciar o App Pool do IIS para carregar a nova versão
      - name: Restart IIS App Pool
        run: |
          $pool = "$env:IIS_APP_POOL"
          if ($pool) { Restart-WebAppPool -Name $pool }
        shell: powershell
